if not twinkhook then
    getgenv().twinkhook = { loaded = true }
    if not game:IsLoaded() then game.Loaded:Wait() end
end

local coreGui = gethui and gethui() or game:GetService("CoreGui")
local camera = workspace.CurrentCamera

-- [FIX 1] Create GUI with Global ZIndex to fix "Box over Text" issues
local drawingUI = Instance.new("ScreenGui")
drawingUI.Name = "Drawing3"
drawingUI.IgnoreGuiInset = true
drawingUI.ZIndexBehavior = Enum.ZIndexBehavior.Global -- Forces strict layer ordering
drawingUI.DisplayOrder = 2147483647
drawingUI.Parent = coreGui

-- Localize Math for Performance
local floor = math.floor
local atan2 = math.atan2
local deg = math.deg
local clamp = math.clamp
local ud2 = UDim2.fromOffset
local v2 = Vector2.new

-- Font Mapping (Offline/Safe Mode)
local fontMap = {
    [0] = Font.fromEnum(Enum.Font.Arial),           -- UI
    [1] = Font.fromEnum(Enum.Font.SourceSans),      -- System
    [2] = Font.fromEnum(Enum.Font.Roboto),          -- Plex
    [3] = Font.fromEnum(Enum.Font.Code),            -- Monospace
}

local function getFont(idx)
    return fontMap[idx] or fontMap[0]
end

local DrawingLib = {}
DrawingLib.Fonts = {
    ['UI'] = 0,
    ['System'] = 1,
    ['Plex'] = 2,
    ['Monospace'] = 3
}

local function BaseObj()
    return {
        Visible = true,
        ZIndex = 1,
        Transparency = 1,
        Color = Color3.new(1,1,1),
        Remove = function(self)
            if self.Object then self.Object:Destroy() end
        end,
        Destroy = function(self)
            if self.Object then self.Object:Destroy() end
        end
    }
end

function DrawingLib.new(type)
    if type == "Line" then
        local obj = BaseObj()
        obj.From = v2(0,0)
        obj.To = v2(0,0)
        obj.Thickness = 1

        local line = Instance.new("Frame")
        line.Name = "Line"
        line.AnchorPoint = Vector2.new(0.5, 0.5)
        line.BorderSizePixel = 0
        line.BackgroundColor3 = obj.Color
        line.Visible = false -- [FIX 2] Hidden by default to prevent ghosts
        line.ZIndex = obj.ZIndex
        line.Parent = drawingUI

        return setmetatable({Object = line}, {
            __index = function(_, k) return obj[k] end,
            __newindex = function(_, k, v)
                obj[k] = v
                if k == "From" or k == "To" or k == "Thickness" then
                    local center = (obj.From + obj.To) / 2
                    local diff = obj.To - obj.From
                    local dist = diff.Magnitude
                    local angle = deg(atan2(diff.Y, diff.X))
                    
                    line.Position = ud2(center.X, center.Y)
                    line.Rotation = angle
                    line.Size = ud2(dist, obj.Thickness)
                elseif k == "Color" then
                    line.BackgroundColor3 = v
                elseif k == "Transparency" then
                    line.BackgroundTransparency = clamp(1 - v, 0, 1)
                elseif k == "Visible" then
                    line.Visible = v
                elseif k == "ZIndex" then
                    line.ZIndex = v
                end
            end
        })

    elseif type == "Text" then
        local obj = BaseObj()
        obj.Text = ""
        obj.Size = 18
        obj.Center = false
        obj.Outline = false
        obj.OutlineColor = Color3.new(0,0,0)
        obj.Position = v2(0,0)
        obj.Font = 0

        local label = Instance.new("TextLabel")
        label.Name = "Text"
        label.BackgroundTransparency = 1
        label.BorderSizePixel = 0
        label.TextColor3 = obj.Color
        label.TextSize = obj.Size
        label.FontFace = getFont(0)
        label.Text = ""
        label.Visible = false -- [FIX 2] Hidden by default
        label.ZIndex = obj.ZIndex
        label.Parent = drawingUI

        local stroke = Instance.new("UIStroke")
        stroke.Thickness = 1
        stroke.Enabled = false
        stroke.Parent = label

        local function updatePos()
            local bounds = label.TextBounds
            label.Size = ud2(bounds.X, bounds.Y)
            if obj.Center then
                label.Position = ud2(obj.Position.X - (bounds.X/2), obj.Position.Y - (bounds.Y/2))
            else
                label.Position = ud2(obj.Position.X, obj.Position.Y)
            end
        end

        return setmetatable({Object = label}, {
            __index = function(_, k) 
                if k == "TextBounds" then return label.TextBounds end
                return obj[k] 
            end,
            __newindex = function(_, k, v)
                obj[k] = v
                if k == "Text" then
                    label.Text = v
                    updatePos()
                elseif k == "Position" or k == "Center" then
                    updatePos()
                elseif k == "Size" then
                    label.TextSize = v
                    updatePos()
                elseif k == "Font" then
                    label.FontFace = getFont(v)
                    updatePos()
                elseif k == "Color" then
                    label.TextColor3 = v
                elseif k == "Transparency" then
                    local t = clamp(1 - v, 0, 1)
                    label.TextTransparency = t
                    stroke.Transparency = t
                elseif k == "Outline" then
                    stroke.Enabled = v
                elseif k == "OutlineColor" then
                    stroke.Color = v
                elseif k == "Visible" then
                    label.Visible = v
                elseif k == "ZIndex" then
                    label.ZIndex = v
                end
            end
        })

    elseif type == "Circle" then
        local obj = BaseObj()
        obj.Radius = 10
        obj.Position = v2(0,0)
        obj.Thickness = 1
        obj.Filled = false

        local circle = Instance.new("Frame")
        circle.Name = "Circle"
        circle.AnchorPoint = Vector2.new(0.5, 0.5)
        circle.BorderSizePixel = 0
        circle.BackgroundColor3 = obj.Color
        circle.BackgroundTransparency = 1
        circle.Visible = false -- [FIX 2] Hidden by default
        circle.ZIndex = obj.ZIndex
        circle.Parent = drawingUI

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(1, 0)
        corner.Parent = circle

        local stroke = Instance.new("UIStroke")
        stroke.Thickness = obj.Thickness
        stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        stroke.Parent = circle

        return setmetatable({Object = circle}, {
            __index = function(_, k) return obj[k] end,
            __newindex = function(_, k, v)
                obj[k] = v
                if k == "Radius" then
                    local d = v * 2
                    circle.Size = ud2(d, d)
                elseif k == "Position" then
                    circle.Position = ud2(v.X, v.Y)
                elseif k == "Color" then
                    circle.BackgroundColor3 = v
                    stroke.Color = v
                elseif k == "Transparency" then
                    local t = clamp(1 - v, 0, 1)
                    if obj.Filled then
                        circle.BackgroundTransparency = t
                    end
                    stroke.Transparency = t
                elseif k == "Filled" then
                    circle.BackgroundTransparency = v and clamp(1 - obj.Transparency, 0, 1) or 1
                    stroke.Enabled = not v
                elseif k == "Thickness" then
                    stroke.Thickness = v
                elseif k == "Visible" then
                    circle.Visible = v
                elseif k == "ZIndex" then
                    circle.ZIndex = v
                end
            end
        })
    
    elseif type == "Square" then
        local obj = BaseObj()
        obj.Size = v2(10,10)
        obj.Position = v2(0,0)
        obj.Thickness = 1
        obj.Filled = false

        local square = Instance.new("Frame")
        square.Name = "Square"
        square.BorderSizePixel = 0
        square.BackgroundColor3 = obj.Color
        square.BackgroundTransparency = 1
        square.Visible = false -- [FIX 2] Hidden by default
        square.ZIndex = obj.ZIndex
        square.Parent = drawingUI

        local stroke = Instance.new("UIStroke")
        stroke.Thickness = obj.Thickness
        stroke.Parent = square

        return setmetatable({Object = square}, {
            __index = function(_, k) return obj[k] end,
            __newindex = function(_, k, v)
                obj[k] = v
                if k == "Size" then
                    square.Size = ud2(v.X, v.Y)
                elseif k == "Position" then
                    square.Position = ud2(v.X, v.Y)
                elseif k == "Color" then
                    square.BackgroundColor3 = v
                    stroke.Color = v
                elseif k == "Transparency" then
                    local t = clamp(1 - v, 0, 1)
                    if obj.Filled then square.BackgroundTransparency = t end
                    stroke.Transparency = t
                elseif k == "Filled" then
                    square.BackgroundTransparency = v and clamp(1 - obj.Transparency, 0, 1) or 1
                    stroke.Enabled = not v
                elseif k == "Thickness" then
                    stroke.Thickness = v
                elseif k == "Visible" then
                    square.Visible = v
                elseif k == "ZIndex" then
                    square.ZIndex = v
                end
            end
        })
    end
    -- Image, Quad, Triangle omitted for safety/simplicity in this optimized version
end

return DrawingLib
