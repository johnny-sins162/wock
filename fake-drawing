if not twinkhook then
    local twinkhook = {
        loaded = false;
    }
    getgenv().twinkhook = twinkhook

    if not game:IsLoaded() then
        game.Loaded:Wait()
    end

    function twinkhook.http_get(path)
        return game:HttpGet('https://github.com/mintylegacy/hook/blob/main/'..path);
    end;
end

-- services
local coreGui = gethui();

-- objects
local camera = workspace.CurrentCamera
local drawingUI = Instance.new("ScreenGui")
drawingUI.Name = "Drawing3"
drawingUI.IgnoreGuiInset = true
drawingUI.ZIndexBehavior = Enum.ZIndexBehavior.Global -- [Fix] Prevents Box drawing over Text
drawingUI.DisplayOrder = 0x7fffffff
drawingUI.Parent = coreGui

-- [Optimization] Localize Math for Speed
local math_floor = math.floor
local math_atan2 = math.atan2
local math_deg = math.deg
local math_clamp = math.clamp
local UDim2_fromOffset = UDim2.fromOffset
local Vector2_zero = Vector2.zero
local Vector2_one = Vector2.one

-- variables
local drawingIndex = 0
local baseDrawingObj = setmetatable({
    Visible = true,
    ZIndex = 0,
    Transparency = 1,
    Color = Color3.new(), -- [Fix] Restored to Black (0,0,0) to fix White Healthbar
    Remove = function(self)
        setmetatable(self, nil)
    end;

    Destroy = function(self)
        self.Object:Destroy();
        setmetatable(self, nil)
    end
}, {
    __add = function(t1, t2)
        local result = table.clone(t1)
        for index, value in t2 do
            result[index] = value
        end
        return result
    end
});

-- [Restored] Original Font Loading Logic
local Fonts = loadstring(twinkhook.http_get('modules/fonts.lua?raw=true'))('twinkhook');

local drawingFontsEnum = {
    [0] = Fonts.Append('tahoma-xp', twinkhook.http_get('fonts/TahomaXP.txt?raw=true')),
    [1] = Fonts.Append('proggy-c', twinkhook.http_get('fonts/ProggyClean.txt?raw=true')),
    [2] = Fonts.Append('proggy-t', twinkhook.http_get('fonts/ProggyTiny.txt?raw=true')),
    [3] = Fonts.Append('pixel-7', twinkhook.http_get('fonts/Pixel.txt?raw=true')),
    [4] = Fonts.Append('minecraftia', twinkhook.http_get('fonts/Minecraftia.txt?raw=true')),
}

local function getFontFromIndex(fontIndex)
    return drawingFontsEnum[fontIndex]
end

local function convertTransparency(transparency)
    return math_clamp(1 - transparency, 0, 1)
end

-- main
local DrawingLib = {}
DrawingLib.Fonts = {
    ['Tahoma'] = 0;
    ['Proggy'] = 1;
    ['Proggy Tiny'] = 2;
    ['Pixel'] = 3;
    ['Minecraftia'] = 4;
}

function DrawingLib.new(drawingType)
    drawingIndex += 1
    if drawingType == "Line" then
        local lineObj = ({
            From = Vector2_zero,
            To = Vector2_zero,
            Thickness = 1
        } + baseDrawingObj)

        local lineFrame = Instance.new("Frame")
        lineFrame.Name = drawingIndex
        lineFrame.AnchorPoint = (Vector2_one * .5)
        lineFrame.BorderSizePixel = 0

        lineFrame.BackgroundColor3 = lineObj.Color
        lineFrame.Visible = false -- [Fix] Hidden default to prevent ghosts
        lineFrame.ZIndex = lineObj.ZIndex
        lineFrame.BackgroundTransparency = convertTransparency(lineObj.Transparency)

        lineFrame.Size = UDim2.new()

        lineFrame.Parent = drawingUI
        return setmetatable({ Object = lineFrame }, {
            __newindex = function(_, index, value)
                if typeof(lineObj[index]) == "nil" then return end
                lineObj[index] = value

                -- [Optimization] Consolidated Math
                if index == "From" or index == "To" or index == "Thickness" then
                    local from = lineObj.From
                    local to = lineObj.To
                    
                    local center = (from + to) / 2
                    local diff = to - from
                    local distance = diff.Magnitude
                    local theta = math_deg(math_atan2(diff.Y, diff.X))

                    lineFrame.Position = UDim2_fromOffset(center.X, center.Y)
                    lineFrame.Rotation = theta
                    lineFrame.Size = UDim2_fromOffset(distance, lineObj.Thickness)
                
                elseif index == "Visible" then
                    lineFrame.Visible = value
                elseif index == "ZIndex" then
                    lineFrame.ZIndex = value
                elseif index == "Transparency" then
                    lineFrame.BackgroundTransparency = convertTransparency(value)
                elseif index == "Color" then
                    lineFrame.BackgroundColor3 = value
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        lineFrame:Destroy()
                        lineObj.Remove(self)
                        return lineObj:Remove()
                    end
                end
                return lineObj[index]
            end
        })
    elseif drawingType == "Text" then
        local textObj = ({
            Text = "",
            Font = DrawingLib.Fonts.Tahoma,
            Size = 0,
            Position = Vector2_zero,
            Center = false,
            Outline = false,
            OutlineColor = Color3.new()
        } + baseDrawingObj)

        local textLabel, textStroke = Instance.new("TextLabel"), Instance.new('UIStroke');
        textLabel.Name = drawingIndex
        textLabel.AnchorPoint = (Vector2_one * .5)
        textLabel.BorderSizePixel = 0
        textLabel.BackgroundTransparency = 1
        textLabel.RichText = true

        textLabel.Visible = false -- [Fix] Hidden default
        textLabel.TextColor3 = textObj.Color
        textLabel.TextTransparency = convertTransparency(textObj.Transparency)
        textLabel.ZIndex = textObj.ZIndex;
        textLabel.FontFace = getFontFromIndex(textObj.Font)
        textLabel.TextSize = textObj.Size;

        textStroke.Parent = textLabel;
        textLabel.TextXAlignment = Enum.TextXAlignment.Left;
        textLabel.Parent = drawingUI

        -- [Optimization] Function to update layout only when needed
        -- Replaces the laggy GetPropertyChangedSignal("TextBounds")
        local function updateTextLayout()
            local textBounds = textLabel.TextBounds
            local offset = textBounds / 2
            textLabel.Size = UDim2_fromOffset(textBounds.X, textBounds.Y)
            
            if textObj.Center then
                textLabel.Position = UDim2_fromOffset(textObj.Position.X, textObj.Position.Y)
            else
                textLabel.Position = UDim2_fromOffset(textObj.Position.X + offset.X, textObj.Position.Y + offset.Y)
            end
        end

        return setmetatable({ Object = textLabel }, {
            __newindex = function(_, index, value)
                if typeof(textObj[index]) == "nil" then return end
                textObj[index] = value

                if index == "Text" then
                    textLabel.Text = value
                    updateTextLayout()
                elseif index == "Font" then
                    value = math_clamp(value, 0, 5)
                    textLabel.FontFace = getFontFromIndex(value)
                    updateTextLayout()
                elseif index == "Size" then
                    textLabel.TextSize = value
                    updateTextLayout()
                elseif index == "Position" then
                    updateTextLayout()
                elseif index == "Center" then
                    updateTextLayout()
                elseif index == "Outline" then
                    textStroke.Enabled = value;
                elseif index == "OutlineColor" then
                    textStroke.Color = value;
                elseif index == "Visible" then
                    textLabel.Visible = value
                elseif index == "ZIndex" then
                    textLabel.ZIndex = value
                elseif index == "Transparency" then
                    local transparency = convertTransparency(value)
                    textLabel.TextTransparency = transparency;
                    textStroke.Transparency = transparency;
                elseif index == "Color" then
                    textLabel.TextColor3 = value
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        textLabel:Destroy()
                        textObj.Remove(self)
                        return textObj:Remove()
                    end
                elseif index == "TextBounds" then
                    return textLabel.TextBounds
                end
                return textObj[index]
            end
        })
    elseif drawingType == "Circle" then
        local circleObj = ({
            Radius = 150,
            Position = Vector2_zero,
            Thickness = .7,
            Filled = false
        } + baseDrawingObj)

        local circleFrame, uiCorner, uiStroke = Instance.new("Frame"), Instance.new("UICorner"), Instance.new("UIStroke")
        circleFrame.Name = drawingIndex
        circleFrame.AnchorPoint = (Vector2_one * .5)
        circleFrame.BorderSizePixel = 0

        circleFrame.BackgroundTransparency = (if circleObj.Filled then convertTransparency(circleObj.Transparency) else 1)
        circleFrame.BackgroundColor3 = circleObj.Color
        circleFrame.Visible = false -- [Fix] Hidden default
        circleFrame.ZIndex = circleObj.ZIndex

        uiCorner.CornerRadius = UDim.new(1, 0)
        circleFrame.Size = UDim2_fromOffset(circleObj.Radius, circleObj.Radius)

        uiStroke.Thickness = circleObj.Thickness
        uiStroke.Enabled = not circleObj.Filled
        uiStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

        circleFrame.Parent, uiCorner.Parent, uiStroke.Parent = drawingUI, circleFrame, circleFrame
        return setmetatable({ Object = circleFrame }, {
            __newindex = function(_, index, value)
                if typeof(circleObj[index]) == "nil" then return end
                circleObj[index] = value

                if index == "Radius" then
                    local radius = value * 2
                    circleFrame.Size = UDim2_fromOffset(radius, radius)
                elseif index == "Position" then
                    circleFrame.Position = UDim2_fromOffset(value.X, value.Y)
                elseif index == "Thickness" then
                    value = math_clamp(value, .6, 0x7fffffff)
                    uiStroke.Thickness = value
                elseif index == "Filled" then
                    circleFrame.BackgroundTransparency = (if value then convertTransparency(circleObj.Transparency) else 1)
                    uiStroke.Enabled = not value
                elseif index == "Visible" then
                    circleFrame.Visible = value
                elseif index == "ZIndex" then
                    circleFrame.ZIndex = value
                elseif index == "Transparency" then
                    local transparency = convertTransparency(value)
                    circleFrame.BackgroundTransparency = (if circleObj.Filled then transparency else 1)
                    uiStroke.Transparency = transparency
                elseif index == "Color" then
                    circleFrame.BackgroundColor3 = value
                    uiStroke.Color = value
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        circleFrame:Destroy()
                        circleObj.Remove(self)
                        return circleObj:Remove()
                    end
                end
                return circleObj[index]
            end
        })
    elseif drawingType == "Square" then
        local squareObj = ({
            Size = Vector2_zero,
            Position = Vector2_zero,
            Thickness = .7,
            Filled = false
        } + baseDrawingObj)

        local squareFrame, uiStroke = Instance.new("Frame"), Instance.new("UIStroke")
        squareFrame.Name = drawingIndex
        squareFrame.BorderSizePixel = 0

        squareFrame.BackgroundTransparency = (if squareObj.Filled then convertTransparency(squareObj.Transparency) else 1)
        squareFrame.ZIndex = squareObj.ZIndex
        squareFrame.BackgroundColor3 = squareObj.Color
        squareFrame.Visible = false -- [Fix] Hidden default

        uiStroke.Thickness = squareObj.Thickness
        uiStroke.Enabled = not squareObj.Filled
        uiStroke.LineJoinMode = Enum.LineJoinMode.Miter

        squareFrame.Parent, uiStroke.Parent = drawingUI, squareFrame
        return setmetatable({ Object = squareFrame }, {
            __newindex = function(_, index, value)
                if typeof(squareObj[index]) == "nil" then return end
                squareObj[index] = value

                if index == "Size" then
                    squareFrame.Size = UDim2_fromOffset(value.X, value.Y)
                elseif index == "Position" then
                    squareFrame.Position = UDim2_fromOffset(value.X, value.Y)
                elseif index == "Thickness" then
                    value = math_clamp(value, 0.6, 0x7fffffff)
                    uiStroke.Thickness = value
                elseif index == "Filled" then
                    squareFrame.BackgroundTransparency = (if value then convertTransparency(squareObj.Transparency) else 1)
                    uiStroke.Enabled = not value
                elseif index == "Visible" then
                    squareFrame.Visible = value
                elseif index == "ZIndex" then
                    squareFrame.ZIndex = value
                elseif index == "Transparency" then
                    local transparency = convertTransparency(value)
                    squareFrame.BackgroundTransparency = (if squareObj.Filled then transparency else 1)
                    uiStroke.Transparency = transparency
                elseif index == "Color" then
                    uiStroke.Color = value
                    squareFrame.BackgroundColor3 = value
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        squareFrame:Destroy()
                        squareObj.Remove(self)
                        return squareObj:Remove()
                    end
                end
                return squareObj[index]
            end
        })
    elseif drawingType == "Image" then
        local imageObj = ({
            Data = "",
            DataURL = "rbxassetid://",
            Size = Vector2_zero,
            Position = Vector2_zero
        } + baseDrawingObj)

        local imageFrame = Instance.new("ImageLabel")
        imageFrame.Name = drawingIndex
        imageFrame.BorderSizePixel = 0
        imageFrame.ScaleType = Enum.ScaleType.Stretch
        imageFrame.BackgroundTransparency = 1

        imageFrame.Visible = false -- [Fix] Hidden default
        imageFrame.ZIndex = imageObj.ZIndex
        imageFrame.ImageTransparency = convertTransparency(imageObj.Transparency)
        imageFrame.ImageColor3 = imageObj.Color

        imageFrame.Parent = drawingUI
        return setmetatable({ Object = imageFrame }, {
            __newindex = function(_, index, value)
                if typeof(imageObj[index]) == "nil" then return end
                imageObj[index] = value

                if index == "Data" then
                    -- later
                elseif index == "DataURL" then -- temporary property
                    imageFrame.Image = value
                elseif index == "Size" then
                    imageFrame.Size = UDim2_fromOffset(value.X, value.Y)
                elseif index == "Position" then
                    imageFrame.Position = UDim2_fromOffset(value.X, value.Y)
                elseif index == "Visible" then
                    imageFrame.Visible = value
                elseif index == "ZIndex" then
                    imageFrame.ZIndex = value
                elseif index == "Transparency" then
                    imageFrame.ImageTransparency = convertTransparency(value)
                elseif index == "Color" then
                    imageFrame.ImageColor3 = value
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        imageFrame:Destroy()
                        imageObj.Remove(self)
                        return imageObj:Remove()
                    end
                elseif index == "Data" then
                    return nil 
                end
                return imageObj[index]
            end
        })
    elseif drawingType == "Quad" then
        local quadObj = ({
            PointA = Vector2_zero,
            PointB = Vector2_zero,
            PointC = Vector2_zero,
            PointD = Vector2_zero,
            Thickness = 1,
            Filled = false
        } + baseDrawingObj)

        local _linePoints = table.create(0)
        _linePoints.A = DrawingLib.new("Line")
        _linePoints.B = DrawingLib.new("Line")
        _linePoints.C = DrawingLib.new("Line")
        _linePoints.D = DrawingLib.new("Line")
        return setmetatable({ Objects = _linePoints }, {
            __newindex = function(_, index, value)
                if typeof(quadObj[index]) == "nil" then return end
                quadObj[index] = value

                if index == "PointA" then
                    _linePoints.A.From = value
                    _linePoints.B.To = value
                elseif index == "PointB" then
                    _linePoints.B.From = value
                    _linePoints.C.To = value
                elseif index == "PointC" then
                    _linePoints.C.From = value
                    _linePoints.D.To = value
                elseif index == "PointD" then
                    _linePoints.D.From = value
                    _linePoints.A.To = value
                elseif (index == "Thickness" or index == "Visible" or index == "Color" or index == "ZIndex") then
                    for _, linePoint in _linePoints do
                        linePoint[index] = value
                    end
                elseif index == "Filled" then
                    -- later
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        for _, linePoint in _linePoints do
                            linePoint:Remove()
                        end

                        quadObj.Remove(self)
                        return quadObj:Remove()
                    end
                end
                return quadObj[index]
            end
        })
    elseif drawingType == "Triangle" then
        local triangleObj = ({
            PointA = Vector2_zero,
            PointB = Vector2_zero,
            PointC = Vector2_zero,
            Thickness = 1,
            Filled = false
        } + baseDrawingObj)

        local _linePoints = table.create(0)
        _linePoints.A = DrawingLib.new("Line")
        _linePoints.B = DrawingLib.new("Line")
        _linePoints.C = DrawingLib.new("Line")
        return setmetatable({ Object = _linePoints }, {
            __newindex = function(_, index, value)
                if typeof(triangleObj[index]) == "nil" then return end
                triangleObj[index] = value

                if index == "PointA" then
                    _linePoints.A.From = value
                    _linePoints.B.To = value
                elseif index == "PointB" then
                    _linePoints.B.From = value
                    _linePoints.C.To = value
                elseif index == "PointC" then
                    _linePoints.C.From = value
                    _linePoints.A.To = value
                elseif (index == "Thickness" or index == "Visible" or index == "Color" or index == "ZIndex") then
                    for _, linePoint in _linePoints do
                        linePoint[index] = value
                    end
                elseif index == "Filled" then
                    -- later
                end
            end,
            __index = function(self, index)
                if index == "Remove" then
                    return function()
                        for _, linePoint in _linePoints do
                            linePoint:Remove()
                        end

                        triangleObj.Remove(self)
                        return triangleObj:Remove()
                    end
                end
                return triangleObj[index]
            end
        })
    end
end

return DrawingLib;
